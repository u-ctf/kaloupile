#!/bin/bash
# PostgreSQL User/Database Sync Script
# Generated from config.yml - DO NOT EDIT MANUALLY
set -e

PGHOST="${PGHOST:-localhost}"
PGPORT="${PGPORT:-5432}"
PGUSER="{{.Postgres.Admin.User}}"
PGPASSWORD="{{.Postgres.Admin.Password}}"
PGDATABASE="{{.Postgres.Admin.Database}}"

export PGPASSWORD

echo "ðŸ”„ Syncing PostgreSQL users and databases..."

# Function to check if user exists
user_exists() {
    psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -tAc "SELECT 1 FROM pg_roles WHERE rolname='$1'" | grep -q 1
}

# Function to check if database exists
db_exists() {
    psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -tAc "SELECT 1 FROM pg_database WHERE datname='$1'" | grep -q 1
}

{{range .Postgres.Users}}
# ============================================================================
# User: {{.Name}}
# ============================================================================
echo "ðŸ‘¤ Processing user: {{.Name}}"

if user_exists "{{.Name}}"; then
    echo "   User {{.Name}} exists, updating password..."
    psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "ALTER USER {{.Name}} WITH PASSWORD '{{.Password}}';"
else
    echo "   Creating user {{.Name}}..."
    psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "CREATE USER {{.Name}} WITH PASSWORD '{{.Password}}';"
fi

{{ $user := . }}

{{range .Databases}}
# Database: {{.}}
if db_exists "{{.}}"; then
    echo "   Database {{.}} exists"
else
    echo "   Creating database {{.}}..."
    psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "CREATE DATABASE {{.}};"
fi

echo "   Granting privileges on {{.}} to user {{$user.Name}}..."
psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -c "GRANT ALL PRIVILEGES ON DATABASE {{.}} TO {{$user.Name}};"

# Grant schema privileges
psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "{{.}}" <<-EOSQL
    GRANT ALL ON SCHEMA public TO {{$user.Name}};
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO {{$user.Name}};
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO {{$user.Name}};
EOSQL

{{end}}
{{end}}

echo "âœ… PostgreSQL sync complete!"
