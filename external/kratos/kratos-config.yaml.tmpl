apiVersion: v1
kind: ConfigMap
metadata:
  name: kratos-config
  namespace: external
data:
  kratos.yml: |
    version: v0.13.0

    dsn: postgres://{{.Kratos.Postgres.User}}:{{getUserPassword .Postgres.Users .Kratos.Postgres.User}}@{{.Postgres.Host}}:{{.Postgres.Port}}/{{.Kratos.Postgres.Database}}?sslmode=disable

    serve:
      public:
        base_url: {{.Scheme}}://kratos.{{.Domain}}/
        cors:
          enabled: true
          allowed_origins:
            - {{.Scheme}}://{{.Domain}}
          allowed_methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
          allowed_headers:
            - Authorization
            - Cookie
          allow_credentials: true
      admin:
        base_url: http://127.0.0.1:{{.Kratos.AdminPort}}/

    selfservice:
      default_browser_return_url: {{.Scheme}}://{{.Domain}}/
      allowed_return_urls:
        - {{.Scheme}}://{{.Domain}}
        - http://localhost:19006/Callback
        - exp://localhost:8081/--/Callback

      methods:
        password:
          enabled: true
        totp:
          config:
            issuer: Kratos
          enabled: true
        lookup_secret:
          enabled: true
        link:
          enabled: true
        code:
          enabled: true
    {{if and .Kratos.GitHub.ClientID .Kratos.GitHub.ClientSecret}}
        oidc:
          enabled: true
          config:
            providers:
              - id: github
                provider: github
                client_id: "{{.Kratos.GitHub.ClientID}}"
                client_secret: "{{.Kratos.GitHub.ClientSecret}}"
                mapper_url: file:///etc/config/kratos/github-mapper.json
                scope:
                  - user:email
    {{end}}

      flows:
        error:
          ui_url: {{.Scheme}}://{{.Domain}}/auth/error

        settings:
          ui_url: {{.Scheme}}://{{.Domain}}/auth/settings
          privileged_session_max_age: 15m
          required_aal: highest_available
          #after:
          #  hooks:
          #    - hook: web_hook
          #      config:
          #        url: http://{{.Kratos.Webhook.LocalIP}}:{{.Kratos.Webhook.Port}}/api/v1/kratos/user-update
          #        method: POST
          #        body: base64://ZnVuY3Rpb24oY3R4KSB7CiAgdXNlcklkOiBjdHguaWRlbnRpdHkuaWQsCiAgdHJhaXRzOiB7CiAgICBlbWFpbDogY3R4LmlkZW50aXR5LnRyYWl0cy5lbWFpbCwKICAgIHVzZXJuYW1lOiBjdHguaWRlbnRpdHkudHJhaXRzLnVzZXJuYW1lLAogIH0sCn0=

        recovery:
          enabled: true
          ui_url: {{.Scheme}}://{{.Domain}}/auth/recovery
          use: code

        verification:
          enabled: true
          ui_url: {{.Scheme}}://{{.Domain}}/auth/verification
          use: code
          after:
            default_browser_return_url: {{.Scheme}}://{{.Domain}}/

        logout:
          after:
            default_browser_return_url: {{.Scheme}}://{{.Domain}}/

        login:
          ui_url: {{.Scheme}}://{{.Domain}}/auth/login
          lifespan: 10m

        registration:
          lifespan: 10m
          ui_url: {{.Scheme}}://{{.Domain}}/auth/registration
    #      after:
    #        password:
    #          hooks:
    #            - hook: session
    #            - hook: web_hook
    #              config:
    #                url: http://{{.Kratos.Webhook.LocalIP}}:{{.Kratos.Webhook.Port}}/api/v1/kratos/user-register
    #                method: POST
    #                body: base64://ZnVuY3Rpb24oY3R4KSB7CiAgdXNlcklkOiBjdHguaWRlbnRpdHkuaWQsCiAgdHJhaXRzOiB7CiAgICBlbWFpbDogY3R4LmlkZW50aXR5LnRyYWl0cy5lbWFpbCwKICAgIHVzZXJuYW1lOiBjdHguaWRlbnRpdHkudHJhaXRzLnVzZXJuYW1lLAogIH0sCn0=
    #{{if and .Kratos.GitHub.ClientID .Kratos.GitHub.ClientSecret}}
    #        oidc:
    #          hooks:
    #            - hook: session
    #            - hook: web_hook
    #              config:
    #                url: http://{{.Kratos.Webhook.LocalIP}}:{{.Kratos.Webhook.Port}}/api/v1/kratos/user-register
    #                method: POST
    #                body: base64://ZnVuY3Rpb24oY3R4KSB7CiAgdXNlcklkOiBjdHguaWRlbnRpdHkuaWQsCiAgdHJhaXRzOiB7CiAgICBlbWFpbDogY3R4LmlkZW50aXR5LnRyYWl0cy5lbWFpbCwKICAgIHVzZXJuYW1lOiBjdHguaWRlbnRpdHkudHJhaXRzLnVzZXJuYW1lLAogIH0sCn0=
    #{{end}}

    log:
      level: debug
      format: text
      leak_sensitive_values: true

    secrets:
      cookie:
        - {{.Kratos.Secrets.Cookie}}
      cipher:
        - {{.Kratos.Secrets.Cipher}}

    ciphers:
      algorithm: xchacha20-poly1305

    hashers:
      argon2:
        parallelism: 1
        memory: 128KB
        iterations: 2
        salt_length: 16
        key_length: 16

    identity:
      default_schema_id: default
      schemas:
        - id: default
          url: file:///etc/config/kratos/identity.schema.json

    courier:
      smtp:
        connection_uri: smtp://mailslurper:1025/?disable_starttls=true

    session:
        cookie:
            domain: {{.Domain}}

    cookies:
        domain: {{.Domain}}